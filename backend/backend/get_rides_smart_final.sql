                                                                                                                                                                                                                                                                           pg_get_functiondef                                                                                                                                                                                                                                                                           
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 CREATE OR REPLACE FUNCTION public.get_rides_smart_final(search_from text, search_to text, radius_km double precision DEFAULT 100)                                                                                                                                                                                                                                                                                                                                                                                                                                     +
  RETURNS TABLE(ride_id uuid, driver_id text, driver_name text, driver_rating numeric, vehicle_make text, vehicle_model text, vehicle_type text, vehicle_plate text, vehicle_color text, max_passengers integer, from_city text, to_city text, from_lat double precision, from_lng double precision, to_lat double precision, to_lng double precision, departuredate timestamp without time zone, availableseats integer, priceperseat numeric, distance_from_city_km double precision, distance_to_city_km double precision, match_type text, direction_score integer)+
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
     from_province text;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
     to_province text;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
     -- ✅ OBTER PROVÍNCIAS DAS CIDADES BUSCADAS                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     SELECT DISTINCT province INTO from_province                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     FROM mozambique_locations                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
     WHERE name ILIKE '%' || search_from || '%'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
        OR district ILIKE '%' || search_from || '%'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
     LIMIT 1;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     SELECT DISTINCT province INTO to_province                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
     FROM mozambique_locations                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
     WHERE name ILIKE '%' || search_to || '%'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
        OR district ILIKE '%' || search_to || '%'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
     LIMIT 1;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     RAISE NOTICE 'Busca: % (%) → % (%)', search_from, COALESCE(from_province, 'N/A'), search_to, COALESCE(to_province, 'N/A');                                                                                                                                                                                                                                                                                                                                                                                                                                        +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     RETURN QUERY                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
     SELECT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
         r.id as ride_id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
         r."driverId" as driver_id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
         COALESCE(u."fullName", r."driverName", 'Motorista') as driver_name,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
         COALESCE(ds."averageRating", 4.5) as driver_rating,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
         COALESCE(dv."vehicleMake", '') as vehicle_make,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
         COALESCE(dv."vehicleModel", 'Veículo') as vehicle_model,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
         COALESCE(dv."vehicleType", r."vehicleType") as vehicle_type,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
         COALESCE(dv."vehiclePlate", 'N/A') as vehicle_plate,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
         COALESCE(dv."vehicleColor", 'Não informada') as vehicle_color,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
         COALESCE(dv."maxPassengers", r."maxPassengers", 4) as max_passengers,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
         r."fromCity"::text as from_city,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
         r."toCity"::text as to_city,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
         ST_Y(r.from_geom) AS from_lat,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
         ST_X(r.from_geom) AS from_lng,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
         ST_Y(r.to_geom) AS to_lat,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
         ST_X(r.to_geom) AS to_lng,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
         r."departureDate" as departuredate,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
         r."availableSeats" as availableseats,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
         r."pricePerSeat" as priceperseat,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
         -- Distâncias                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
         CASE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
             WHEN r.from_geom IS NOT NULL AND lf.lat IS NOT NULL THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
                 ST_Distance(ST_SetSRID(ST_MakePoint(lf.lng, lf.lat), 4326)::geography, r.from_geom::geography) / 1000                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
             ELSE 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
         END AS distance_from_city_km,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
         CASE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
             WHEN r.to_geom IS NOT NULL AND lt.lat IS NOT NULL THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
                 ST_Distance(ST_SetSRID(ST_MakePoint(lt.lng, lt.lat), 4326)::geography, r.to_geom::geography) / 1000                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
             ELSE 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
         END AS distance_to_city_km,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
         -- ✅ SISTEMA DE MATCHING INTELIGENTE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
         CASE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
             -- 1. MATCH PERFEITO: cidades iguais                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
             WHEN r."fromCity" ILIKE '%' || search_from || '%' AND r."toCity" ILIKE '%' || search_to || '%' THEN 'exact_city'                                                                                                                                                                                                                                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
             -- 2. MATCH DE PROVÍNCIA: províncias iguais                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
             WHEN r."fromProvince" ILIKE '%' || COALESCE(from_province, search_from) || '%'                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
                  AND r."toProvince" ILIKE '%' || COALESCE(to_province, search_to) || '%' THEN 'exact_province'                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
             -- 3. MATCH PARCIAL: origem correta                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
             WHEN r."fromCity" ILIKE '%' || search_from || '%' OR r."fromProvince" ILIKE '%' || COALESCE(from_province, search_from) || '%' THEN 'partial_from'                                                                                                                                                                                                                                                                                                                                                                                                        +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
             -- 4. MATCH PARCIAL: destino correto                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
             WHEN r."toCity" ILIKE '%' || search_to || '%' OR r."toProvince" ILIKE '%' || COALESCE(to_province, search_to) || '%' THEN 'partial_to'                                                                                                                                                                                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
             -- 5. MATCH POR PROXIMIDADE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
             WHEN (r.from_geom IS NOT NULL AND lf.lat IS NOT NULL AND ST_Distance(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
                 ST_SetSRID(ST_MakePoint(lf.lng, lf.lat), 4326)::geography,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
                 r.from_geom::geography                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
             ) <= radius_km * 1000) OR (r.to_geom IS NOT NULL AND lt.lat IS NOT NULL AND ST_Distance(                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
                 ST_SetSRID(ST_MakePoint(lt.lng, lt.lat), 4326)::geography,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
                 r.to_geom::geography                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
             ) <= radius_km * 1000) THEN 'nearby'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
             -- 6. BUSCA VAZIA: retorna tudo                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
             WHEN search_from = '' AND search_to = '' THEN 'all_rides'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
             ELSE 'other'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
         END as match_type,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
         -- ✅ SISTEMA DE PONTUAÇÃO POR DIREÇÃO (SIMPLIFICADO)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
         CASE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
             -- MÁXIMA PONTUAÇÃO: direção perfeita + cidades iguais                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
             WHEN r."fromCity" ILIKE '%' || search_from || '%' AND r."toCity" ILIKE '%' || search_to || '%' THEN 100                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
             -- ALTA PONTUAÇÃO: direção perfeita + províncias iguais                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
             WHEN r."fromProvince" ILIKE '%' || COALESCE(from_province, search_from) || '%'                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
                  AND r."toProvince" ILIKE '%' || COALESCE(to_province, search_to) || '%' THEN 90                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
             -- BOA PONTUAÇÃO: origem correta                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
             WHEN r."fromCity" ILIKE '%' || search_from || '%' OR r."fromProvince" ILIKE '%' || COALESCE(from_province, search_from) || '%' THEN 80                                                                                                                                                                                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
             -- PONTUAÇÃO MÉDIA: destino correto                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
             WHEN r."toCity" ILIKE '%' || search_to || '%' OR r."toProvince" ILIKE '%' || COALESCE(to_province, search_to) || '%' THEN 60                                                                                                                                                                                                                                                                                                                                                                                                                              +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
             -- PONTUAÇÃO BAIXA: apenas proximidade                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
             WHEN (r.from_geom IS NOT NULL AND lf.lat IS NOT NULL AND ST_Distance(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
                 ST_SetSRID(ST_MakePoint(lf.lng, lf.lat), 4326)::geography,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
                 r.from_geom::geography                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
             ) <= radius_km * 1000) OR (r.to_geom IS NOT NULL AND lt.lat IS NOT NULL AND ST_Distance(                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
                 ST_SetSRID(ST_MakePoint(lt.lng, lt.lat), 4326)::geography,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
                 r.to_geom::geography                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
             ) <= radius_km * 1000) THEN 40                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
             -- BUSCA VAZIA: pontuação neutra                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
             WHEN search_from = '' AND search_to = '' THEN 50                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
             ELSE 10                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
         END as direction_score                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     FROM rides r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
     LEFT JOIN users u ON r."driverId" = u.id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
     LEFT JOIN "driverStats" ds ON r."driverId" = ds."driverId"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
     LEFT JOIN "driverVehicles" dv ON r."vehicleId" = dv.id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     -- LATERAL com fallback                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
     LEFT JOIN LATERAL (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
         SELECT lat, lng                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
         FROM mozambique_locations                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
         WHERE name ILIKE '%' || search_from || '%'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
            OR district ILIKE '%' || search_from || '%'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
            OR province ILIKE '%' || search_from || '%'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
         ORDER BY                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
             CASE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
                 WHEN name ILIKE '%' || search_from || '%' THEN 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
                 WHEN district ILIKE '%' || search_from || '%' THEN 2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
                 WHEN province ILIKE '%' || search_from || '%' THEN 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
                 ELSE 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
             END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
         LIMIT 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     ) lf ON true                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     LEFT JOIN LATERAL (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
         SELECT lat, lng                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
         FROM mozambique_locations                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
         WHERE name ILIKE '%' || search_to || '%'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
            OR district ILIKE '%' || search_to || '%'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
            OR province ILIKE '%' || search_to || '%'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
         ORDER BY                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
             CASE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
                 WHEN name ILIKE '%' || search_to || '%' THEN 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
                 WHEN district ILIKE '%' || search_to || '%' THEN 2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
                 WHEN province ILIKE '%' || search_to || '%' THEN 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
                 ELSE 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
             END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
         LIMIT 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     ) lt ON true                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     WHERE r.status = 'available'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
       AND r."departureDate" > NOW()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
       AND r."availableSeats" > 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
       -- ✅ FILTRO MAIS FLEXÍVEL MAS INTELIGENTE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
       AND (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
           -- BUSCA VAZIA: retorna tudo                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
           (search_from = '' AND search_to = '')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
           OR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
           -- BUSCA COM PARÂMETROS: aplicar lógica inteligente                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
           (search_from != '' AND search_to != '' AND (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
               -- CORRESPONDÊNCIA DE DIREÇÃO (não sentido oposto)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
               (r."fromCity" ILIKE '%' || search_from || '%' OR r."fromProvince" ILIKE '%' || COALESCE(from_province, search_from) || '%')                                                                                                                                                                                                                                                                                                                                                                                                                             +
               AND (r."toCity" ILIKE '%' || search_to || '%' OR r."toProvince" ILIKE '%' || COALESCE(to_province, search_to) || '%')                                                                                                                                                                                                                                                                                                                                                                                                                                   +
           ))                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
           OR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
           -- BUSCA APENAS COM ORIGEM                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
           (search_from != '' AND search_to = '' AND (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
               r."fromCity" ILIKE '%' || search_from || '%' OR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
               r."fromProvince" ILIKE '%' || COALESCE(from_province, search_from) || '%' OR                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
               (r.from_geom IS NOT NULL AND lf.lat IS NOT NULL AND ST_Distance(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
                   ST_SetSRID(ST_MakePoint(lf.lng, lf.lat), 4326)::geography,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
                   r.from_geom::geography                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
               ) <= radius_km * 1000)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
           ))                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
           OR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
           -- BUSCA APENAS COM DESTINO                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
           (search_from = '' AND search_to != '' AND (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
               r."toCity" ILIKE '%' || search_to || '%' OR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
               r."toProvince" ILIKE '%' || COALESCE(to_province, search_to) || '%' OR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
               (r.to_geom IS NOT NULL AND lt.lat IS NOT NULL AND ST_Distance(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
                   ST_SetSRID(ST_MakePoint(lt.lng, lt.lat), 4326)::geography,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
                   r.to_geom::geography                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
               ) <= radius_km * 1000)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
           ))                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
       )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     ORDER BY                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
         direction_score DESC,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
         CASE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
             WHEN match_type = 'exact_city' THEN 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
             WHEN match_type = 'exact_province' THEN 2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
             WHEN match_type = 'partial_from' THEN 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
             WHEN match_type = 'partial_to' THEN 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
             WHEN match_type = 'nearby' THEN 5                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
             WHEN match_type = 'all_rides' THEN 6                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
             ELSE 7                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
         END,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
         (COALESCE(distance_from_city_km, 1000) + COALESCE(distance_to_city_km, 1000)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
         departuredate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
     LIMIT 50;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
 END;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
 
(1 row)

